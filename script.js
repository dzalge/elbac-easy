document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const inputSection = document.getElementById('input-section');
    const quizSection = document.getElementById('quiz-section');
    const eventInputsContainer = document.getElementById('event-inputs');
    const personalityInputsContainer = document.getElementById('personality-inputs');
    const addEntryButtons = document.querySelectorAll('.add-entry-btn');
    const startQuizButtons = document.querySelectorAll('.start-category-quiz-btn');
    const inputMessage = document.getElementById('input-message');

    const quizScoreDisplay = document.getElementById('quiz-score-display');
    const questionCountDisplay = document.getElementById('question-count-display');
    const totalQuestionsDisplay = document.getElementById('total-questions-display');
    const quizCategoryDisplay = document.getElementById('quiz-category-display');
    const quizQuestionDisplay = document.getElementById('quiz-question-display');
    const choiceButtonsContainer = document.getElementById('choice-buttons-container');
    const helpButton = document.getElementById('help-button');

    const quizFeedbackDisplay = document.getElementById('quiz-feedback-display');
    const correctAnswerDisplay = document.getElementById('correct-answer-display');
    const nextQuestionBtn = document.getElementById('next-question-btn');
    const restartQuizBtn = document.getElementById('restart-quiz-btn');
    const backToInputBtn = document.getElementById('back-to-input-btn');

    // --- Game State Variables ---
    let eventsFlashcards = [];
    let personalitiesFlashcards = [];

    let currentQuizFlashcards = [];
    let currentQuizCategoryLabel = '';
    let currentQuizSubCategoryKey = '';
    let currentMainCategoryKey = '';

    let currentQuizIndex = 0;
    let quizScore = 0;
    let quizQuestions = [];
    let currentChoices = [];
    let helpUsedThisQuestion = false;

    // --- Default Data - Organized by Categories and Sub-categories ---
    const defaultData = {
        events: {
            coldWarEvents: [
                { term: 'اتفاقية بروتن وودز', definition: '22 جويلية 1944' },
                { term: 'مؤتمر يالطا', definition: 'من 4 الى 11 فيفري 1945' },
                { term: 'تفجير قنبلتين نوويتين على هايروشيما و نكازاكي', definition: '6  و  9 اوت   1945' },
                { term: 'تأسيس هيئة الامم المتحدة', definition: '24  اكتوبر 1945' },
                { term: 'مبدا ترومان', definition: '12 مارس 1947' },
                { term: 'مشروع مارشال', definition: '5 جوان 1947' },
                { term: 'مبدأ جدانوف', definition: '22 سبتمبر 1947' },
                { term: 'انشاء مكتب الكومنفورم', definition: '5/6اكنوبر  1947' },
                { term: 'تأسيس منظمة الكوميكون', definition: '25 جانفي 1949' },
                { term: 'تأسيس حلف الناتو(الاطلسي)', definition: '04 ─04 ─1949' },
                { term: 'تأسيس المانيا الغربية الاتحادية', definition: '8 ماي 1949' },
                { term: 'انتصار الثورة الشيوعية في الصين بقيادة ماوسي تونغ', definition: '1 اكتوبر 1949' },
                { term: 'تأسيس المانيا الشرقية الديمقراطية', definition: '7 اكتوبر 1949' },
                { term: 'وفاة جوزيف ستالين', definition: '5 مارس 1953' },
                { term: 'تأسيس حلف سياتو (جنوب شرق اسيا)', definition: '8 سبتمبر 1954' },
                { term: 'تأسيس حلف بغداد', definition: '24 فيفري 1955' },
                { term: 'مؤتمر باندونغ', definition: 'من 18 الى 24 افريل 1955' },
                { term: 'تأسيس حلف وارسو', definition: '14 ماي 1955' },
                { term: 'خروتشوف  يتبنى  التعايش  السلمي', definition: '14 فيفري 1956' },
                { term: 'حل مكتب الكومنفورم', definition: '17 افريل 1956' },
                { term: 'الاعلان عن مشروع ايزنهاور', definition: '5 جانفي 1957' },
                { term: 'زيارة خروتشوف لواشنطن', definition: 'من 15 الى 18  سبتمبر 1959' },
                { term: 'اول رحلة لإنسان  الى الفضاء (يوري غرغارين)', definition: '12 افريل 1961' },
                { term: 'بناء جدار برلين', definition: '13  اوت 1961' },
                { term: 'المؤتمر التأسيسي لحركة عدم الانحياز ببلغراد', definition: '1 / 6 سبتمبر 1961' },
                { term: 'انشاء الخط الهاتفي الاحمر بين موسكو و واشنطن', definition: '20 جوان 1963' },
                { term: 'اتفاقية الحد من الاسلحة الاستراتيجية  1 (سالت 01)', definition: 'من 22 الى 26 ماي 1972' },
                { term: 'المؤتمر الرابع لحركة عدم الانحياز بالجزائر', definition: 'من 5 الى 9  سبتمبر 1973' },
                { term: 'اتفاقية الحد من الاسلحة الاستراتيجية  2 (سالت 02)', definition: '18 جوان 1979' },
                { term: 'التدخل السوفياتي في افغانستان', definition: '27 ديسمبر 1979' },
                { term: 'وصول غورباتشوف لسدة الحكم في الا س', definition: '11 مارس 1985' },
                { term: 'تحطيم جدار برلين', definition: '9 نوفمبر 1989' },
                { term: 'مؤتر مالطا', definition: '03 و04 ديسمبر 1989' },
                { term: 'توحيد الالمانيتين', definition: '3 اكتوبر 1990' },
                { term: 'مؤتمر باريس', definition: 'من 19 الى 21 ديسمبر 1990' },
                { term: 'حل منظمة الكوميكون', definition: '28 جوان 1991' },
                { term: 'حل حلف وارسو', definition: '1 جويلية 1991' },
                { term: 'مؤتمر الما اتا  و ظهور مجموعة الدول المستقلة', definition: '21 ديسمبر 1991' },
                { term: 'استقالة غورباتشوف من رئاسة الاتحاد السوفياتي', definition: '25 ديسمبر 1991' }
            ],
            algerianRevolutionEvents: [
                { term: 'تأسيس اللجنة الثورية للوحدة والعمل', definition: '23 مارس  1954' },
                { term: 'اجتماع مجموعة 22', definition: '23 جوان 1954' },
                { term: 'اجتماع لجنة 6', definition: '23 اكتوبر 1954' },
                { term: 'مشروع جاك سوستال', definition: '15 فيفري 1955' },
                { term: 'اعلان حالة الطوارئ', definition: '1 افريل 1955' },
                { term: 'هجومات الشمال القسنطيني', definition: '20 اوت 1955' },
                { term: 'تاسيس الاتحاد العام للعمال الجزائريين', definition: '24 فيفري 1956' },
                { term: 'اضراب الطلبة الجزائريين', definition: '19 ماي 1956' },
                { term: 'اختطاف طائرة الزعماء الخمس', definition: '22 اكتوبر 1956' },
                { term: 'اضراب الثمانية ايام', definition: '28 جانفي – 4فيفري 1957' },
                { term: 'قصف ساقية سيدي يوسف', definition: '8 فيفري 1958' },
                { term: 'تأسيس الحكومة المؤقتة  الجزائرية', definition: '19 سبتمبر 1958' },
                { term: 'الاعلان عن مشروع قسنطينة', definition: '3 اكتوبر 1958' },
                { term: 'مشروع سلم الشجعان', definition: '23 اكتوبر 1958' },
                { term: 'قيام الجمهورية الفرنسية الخامسة', definition: '8 جانفي 1959' },
                { term: 'مشروع حق تقرير المصير', definition: '16 سبتمبر 1959' },
                { term: 'مفاوضات مولان', definition: '25 -30 جوان 1960' },
                { term: 'مظاهرات في بلكور الجزائر', definition: '11 ديسمبر 1960' },
                { term: 'مفاوضات لوزان', definition: '20 فيفري 1961' },
                { term: 'مظاهرات الجالية بباريس', definition: '17 اكتوبر 1961' },
                { term: 'مفاوضات ايفيان', definition: '7 -18 مارس 1962' },
                { term: 'التوقيع على اتفاقيات ايفيان', definition: '18 مارس 1962' },
                { term: 'وقف اطلاق النار', definition: '19 مارس 1962' },
                { term: 'انشاء الهيئة الؤقتة', definition: '29 مارس 1962' },
                { term: 'مؤتمر طرابلس', definition: '27 ماي -4 جوان 1962' },
                { term: 'استفتاء تقرير المصير', definition: '1 جويلية 1962' },
                { term: 'الاعلان عن نتائج الاستفتاء', definition: '2 جويلية 1962' },
                { term: 'الاعلان  عن الاستقلال', definition: '5 جويلية 1962' },
                { term: 'قيام ج ج د ش', definition: '25 سبتمبر 1962' },
                { term: 'انضمام الجزائر لهيئة الامم المتحدة', definition: '8 اكتوبر 1962' },
                { term: 'انقلاب بومدين على بن بلة –التصحيح الثوري', definition: '19 جوان 1965' },
                { term: 'مظاهرات شعبية', definition: '5 اكتوبر 1988' },
                { term: 'دستور التعددية الحزبية', definition: '23 فيفري 1989' }
            ],
            palestineEvents: [
                { term: 'الثورة الفلسطينية المسلحة', definition: '01/01/1965' },
                { term: 'إعلان قيام دولة فلسطين من الجزائر', definition: '15/11/1988' }
            ]
        },
        personalities: {
            coldWarPersonalities: [
                { term: 'فراكلين روزفلت', definition: 'هو رئيس امريكي قاد الو م ا للنصر في ح ع 2 وحضر مؤتمر يالطا 1945.' },
                { term: 'هاري ترومان', definition: 'هو رئيس امريكي امر بقصف هيروشيما وناكازاكي وحضر مؤتمر بوتسدام في صيف 1945.' },
                { term: 'دوايت ايزنهاور', definition: 'هو رئيس امريكي انتهج سياسة ملا الفراغ و صاحب مشروع ايزنهاور جانفي 1957.' },
                { term: 'جون كينيدي', definition: 'هو رئيس امريكي وقعت في عهدته ازمة كوبا 1962 اشتهر بوقوفه ضد التمييز العنصري.' },
                { term: 'ريتشارد نيكسون', definition: 'هو رئيس امريكي وقع على اتفاقية سالت (1) 1972 استقال بعد فضيحة وتر غايت.' },
                { term: 'جيمي كارتر', definition: 'هو رئيس امريكي وقع على اتفاقية سالت (2) 1979 واشرف على اتفاقية كام دايفد المشؤومة.' },
                { term: 'رونالد ريغن', definition: 'هو رئيس امريكي صاحب فكرة حرب النجوم و عرفت سياسته الخارجية بالتشدد.' },
                { term: 'جورج بوش الاب', definition: 'هو رئيس امريكي وقع على نهاية الحرب الباردة بمالطا 89 و تدخل عسكريا في العراق.' },
                { term: 'بيل كلينتون', definition: 'هو رئيس امريكي ساهم في اتفاقية السلام الفلسطينية الاسرائيلية بغزة واريحا سنة 1993.' },
                { term: 'جورج مارشال', definition: 'كاتب الدولة للخارجية الامريكية جنرال في الح ع 2 و صاحب مشروع مارشال 05/06/1947.' },
                { term: 'جوزيف ستالين', definition: 'رئيس سوفياتي قاد الا س في ح ع 2( 39-45) واشتهر بالتشدد وكرهه الشديد للغرب.' },
                { term: 'نيكتا خروتشوف', definition: 'رئيس سوفياتي صاحب مبادرة التعايش السلمي اول زعيم سوفيتي يزور و م ا 1959.' },
                { term: 'ليونيد بريجنيف', definition: 'رئيس سوفياتي وقع على سالت 1 (72)و2(79) وربيع براغ( 68)و غزو افغانستان(79).' },
                { term: 'ميخائيل غوربتشوف', definition: 'اخر رئيس سوفياتي مهندس البروسترويكا والغلاسنوست وقع نهاية الحرب الباردة 1989.' },
                { term: 'اندري جدانوف', definition: 'سياسي سوفيتي صاحب اطروحة الكتلتين (شرقية وغربية)و مبدا جدانوف 22/09/47.' },
                { term: 'مولوتوف', definition: 'وزير الخارجية السوفيتي ايام حكم ستالين ومؤسس منظمة الكوميكون 25/01/1949.' },
                { term: 'ونستن تشرشل', definition: 'رئيس الوزراء في بريطانيا لعهدتين صاحب مصطلح الستار الحديدي1946.' },
                { term: 'احمد سوكارنو', definition: 'رئيس اندونيسيا من ابرز زعماء العالم الثالث خلال النصف الثاني للقرن العشرين ساهم في تحرير بلده من الاستعمار الهولندي,شارك في مؤتمر باندونغ 1955 و يعد من مؤسسي حركة عدم الانحياز 1961ببلغراد.' },
                { term: 'جواهر لال نهرو', definition: 'رئيس الحكومة الهندية من ابرز زعماء العالم الثالث خلال النصف الثاني للقرن العشرين ساهم في تحرير بلده من الاستعمار البريطاني ,شارك في مؤتمر باندونغ 1955 و يعد من مؤسسي حركة عدم الانحياز 1961ببلغراد.' },
                { term: 'جوزيف بروز تيتو', definition: 'رئيس يوغسلافيا +## من ابرز زعماء العالم الثالث خلال النصف الثاني للقرن العشرين ساهم في تحرير بلده من الاستعمار النازي في الح ع 2, يعد من مؤسسي حركة عدم الانحياز 1961ببلغراد' },
                { term: 'جمال عبد الناصر', definition: 'زعيم مصري احد جماعة الضباط الاحرار المصرية 1952 امم قناة السويس 1956م من ابرز زعماء العالم الثالث خلال النصف الثاني للقرن العشرين,شارك في مؤتمر باندونغ 1955 و يعد من مؤسسي حركة عدم الانحياز 1961ببلغراد.' },
                { term: 'شي غيفارا', definition: 'طبيب أرجنتيني ،احد ابرز مناهضي الامبريالية و اشهر مناضلي الحركات التحررية الثورية في أمريكا اللاتينية قاد الثورة الكوبية إلى جانب كاسترو سنة 1959.' },
                { term: 'فدال كاسترو', definition: 'زعيم ورئيس كوبا الشيوعية بعد نجاح الثورة سنة 1959.عرفت فترة حكمه أزمة كوبا1963.احد ابرز رجالات الحركة التحررية بأمريكا اللاتينية و برز مناهضي الامبريالية في العالم.' },
                { term: 'هوشي منه', definition: 'سياسي فتنامي شيوعي، قائد الحركة التحررية في الهند الصينية.ضد اليابان ثم فرنسا ثم الو م ا من مؤسس الحزب الشيوعي الفيتنامي 1931. راس جمهورية الفيتنام الشمالية بعد استقلالها.' },
                { term: 'الجنرال جياب', definition: 'عسكري فيتنامي،قائد القوات الفيتنامية الشمالية في معركة ديان بيان فو ضد فرنسا 1954.' },
                { term: 'المهاتما غاندي', definition: 'أحد أكبر القادة السياسيين في القرن 20 ساهم في تحرير الهند من الاحتلال البريطاني سنة 1947 مهندس فلسفة اللاعنف.' },
                { term: 'تيودور هرتزل', definition: 'كبار الحركة الصهيونية ،ترأس مؤتمر بال 1897.صاحب فكرة إنشاء وطن قومي لليهود.' },
                { term: 'ياسر عرفات', definition: 'رئيس منظمة التحرير الفلسطينية وحركة فتح منذ1969، رئيس السلطة الفلسطينية في مناطق الحكم الذاتي سنة 1994.' }
            ],
            algerianRevolutionPersonalities: [
                { term: 'مصطفى بن بولعيد', definition: 'مناضل جزائري قائد المنطقة الاولى (الاوراس 1954) انخرط في حزب الشعب (1937) . انضم للمنظمة الخاصة (1947) من مفجري الثورة (1954).' },
                { term: 'ديدوش مراد', definition: 'مناضل جزائري قائد المنطقة الثانية (الشمال القسنطيني 1954) انخرط في حزب الشعب (1937) . انضم للمنظمة الخاصة (1947) من مفجري الثورة (1954).' },
                { term: 'كريم بلقاسم', definition: 'قائد المنطقة الثالثة( القبائل1954) انخرط في حزب الشعب (1937) . انضم للمنظمة الخاصة (1947) من مفجري الثورة (1954).' },
                { term: 'رابح بيطاط', definition: 'قائد المنطقة الرابعة ( العاصمة 1954) انخرط في حزب الشعب (1937) . انضم للمنظمة الخاصة (1947) من مفجري الثورة (1954).' },
                { term: 'العربي بن مهيدي', definition: 'قائد المنطقة الخامسة (وهران 1954) انخرط في حزب الشعب (1937) . انضم للمنظمة الخاصة (1947) من مفجري الثورة (1954).' },
                { term: 'محمد بلوزداد', definition: 'مناضل جزائري توفي قبل اندلاع الثورة( 14/01/1952) انخرط في حزب الشعب (1937) . تراس المنظمة الخاصة (1947).' },
                { term: 'زيغود يوسف', definition: 'مناضل جزائري قائد هجومات الشمال القسنطيني( 20/08/1955) انخرط في حزب الشعب (1937) . انضم للمنظمة الخاصة (1947) من مفجري الثورة (1954).' },
                { term: 'احمد بن بلة', definition: 'اول رئيس للجمهورية الجزائرية (63/65) انخرط في حزب الشعب (1937) . انضم للمنظمة الخاصة (1947) من مفجري الثورة (1954).' },
                { term: 'محمد بوضياف', definition: 'من جماعة الستة تولى رئاسة الجمهورية الجزائرية (جانفي /جوان 1992) انخرط في حزب الشعب (1937) . انضم للمنظمة الخاصة (1947) من مفجري الثورة (1954).' },
                { term: 'عبان ومضان', definition: 'مهندس مؤتمر الصومام (20/08/1956) انخرط في حزب الشعب (1937) . انضم للمنظمة الخاصة (1947) من مفجري الثورة (1954).' },
                { term: 'حسين ايت احمد', definition: 'رئيس الوفد الجزائري بمؤتمر باندونغ (18-24/04/1955) توفي 2015م انخرط في حزب الشعب (1937) . انضم للمنظمة الخاصة (1947) من مفجري الثورة (1954).' },
                { term: 'مصالي الحاج', definition: 'من زعماء الحركة الوطنية في الجزائر اسس جزب الشعب 1937 و حركة انتصار الحريات الديمقراطية 1946م وحزب الحركة الوطنية الجزائرية 1954.' },
                { term: 'فرحات عباس', definition: 'من رجالات الحركة الوطنية احد دعاة الادماج قبل الثورة انضم للثورة سنة 1956 و تراس اول حكومة جزائرية مؤقتة 19/09/1958م.' },
                { term: 'بن يوسف بن خدة', definition: 'عضو حزب الشعب و حركة انتصار الحريات الديمقراطية من المركزيين خلف فرحات عباس على رئاسة الحكومة المؤقتة الجزائرية 28/08/1961م.' },
                { term: 'هواري بومدين', definition: 'قائد اركان جيش التحرير الوطني سنة1960 ووزير الدفاع في حكومة الاستقلال 1962 ثم رئيس الجمهورية بعد جوان 1965 يعد من ابرز رجالات حركة عدم الانحياز خاصة بعد مؤتمر الجزائر 1973.' },
                { term: 'فرانسوا ميتران', definition: 'سياسي فرنسي تولى حقيبة وزارة الداخلية مع اندلاع الثورة في 01 نوفمبر 1954. ليصبح رئيس للجمهوريةالفرنسية سنة 1981م حاول القضاء على الثورة لكنه فشل.' },
                { term: 'بيار منداس فرانس', definition: 'رئيس الحكومة الفرنسية ابان اندلاع الثورة التحريرية حاول القضاء عليها لكنه فشل وسقطت حكومته في فيفري 1955.' },
                { term: 'غي مولي', definition: 'رئيس حكومة فرنسا من( 1956/1957.) حاول القضاء على الثورة التحريرية لكنه فشل.' },
                { term: 'جاك سوستال', definition: 'الحاكم العام الفرنسي في الجزائر 01/02/1955م عرف بمشروع سوستال 1955 ينص بتقديم مساعدات اغرائية لعزل الشعب عن الثورة لكنه فشل.' },
                { term: 'شارل ديغول', definition: 'محرر باريس من المانيا في الح ع 2 عاد منقذا للجمهورية سنة 1958 لينتخب كأول رئيس للجمهورية الفرنسية الخامسة 1959 /1969،.حاول القضاء على الثورة لكنه فشل.' }
            ]
        },
        terms: {
            historyTerms: [
                { term: 'العالم الثالث', definition: 'مصطلح ظهر في1952 اطلقه الفرنسي ألفريد صوفي للتمييز بينه وبين العالم الرأسمالي و الاشتراكي و يضم دول أسيا وإفريقيا وأمريكا اللاتينية' },
                { term: 'الراسمالية', definition: 'مذهب اقتصادي غربي يرتكز على مبدأ الحرية الفردية ويستبعد أي تدخل للدولة في الشؤون الاقتصادية.' },
                { term: 'الاشتراكية', definition: 'نظام اقتصادي يقوم على مبدا الملكية الجماعية وهيمنة الدولة على مناحي الحياة وهو مناهض للرأسمالية تبناها الا .س  بعد نجاح الثورة البلشفية 1917' },
                { term: 'الإمبريالية', definition: 'هيمنة اقتصادية وعسكرية و سياسية لدولة على دولة أخرى وهي صورة أخرى للاستعمار التقليدي .عرفت به الو م ا' },
                { term: 'الشرق', definition: 'يقصد به الدول التي تقع في شرق أوربا و الصين و كوريا ش و كوبا والفيتنام التي طبقت النظام الشيوعي الاشتراكي أثناء الحرب الباردة 1945-1989' },
                { term: 'الغرب', definition: 'الدول الديمقراطية الرأسمالية التي تقع غرب أوربا وكذلك الو.م .الأمريكية و كندا و استراليا واليابان وكورياج . التي طبقت النظام اللبيرالي الراسمالي أثناء الحرب الباردة 1945-1989' },
                { term: 'حلف الناتو', definition: 'حلف عسكري يضم الدول الرأسمالية الليبرالية بزعامة الو م أ بهدف مواجهة إلمعسكر الشيوعي و حركات التحرر تاسس في 4/4/1949مقره بروكسل' },
                { term: 'حلف وارسو', definition: 'حلف عسكري تابع للمعسكر الشيوعي الاشتراكبقيادة الا س يهدف إلى مواجهة تحديات الغرب الرأسمالي تاسس 14/05/1955 مقره وارسو' },
                { term: 'الكريملين', definition: 'مقر الرئاسة السوفياتية بالعاصمة موسكو .' },
                { term: 'البيت الأبيض', definition: 'هو مقر رئيس الو م أ بواشنطن' },
                { term: 'الستار الحديدي', definition: 'مفهوم استعمله رئيس وزراء بريطانيا ونستون تشرشل سنة 1946 لما تحدث عن أطماع الاتحاد السوفياتي التوسعية في أوروبا الشرقية ويمتد من منطقة ستايتن على بحر البلطيق إلى ميناء تريستيا الايطالي .' },
                { term: 'الصراع الاديولوجي', definition: 'هو صراع فكري حضاري بين الشيوعية و الرأسمالية بحيث يسعى كل طرف لفرض مذهبه على العالم' },
                { term: 'سياسة ملء الفراغ', definition: 'سياسة استعمارية تبنتها الو .م .ا بعد ضعف و انسحاب القوى الاستعمارية قابلها الا. س بدعم حركات التحرر' },
                { term: 'سياسة الاحتواء', definition: 'سياسة تقوم على إنشاء سلسلة من الأحلاف والقواعد العسكرية لتطويق وعزل الإ .س ومنع انتشار نفوذه وإيديولوجيته .' },
                { term: 'التوازن النووي', definition: '( توازن الرعب ) أي امتلاك كل من الو .م. أ و الإ. س للسلاح النووي مما حال دون اندلاع مواجهة عسكرية بينهما .' },
                { term: 'القطبية الثنائية', definition: 'نظام ميز العلاقات الدولية منذ 1945 و حتى 1989 بوجود قطبين مؤثرين على الساحة الدولية هما الو م أ والإ .س .' },
                { term: 'سياسة الاحلاف', definition: 'سياسة تقوم على تأسيس تكتلات عسكرية تضم دولا ذات مصالح مشتركة بزعامة إحدى القوتين مثل الناتو وارسو' },
                { term: 'سياسة المشاريع', definition: 'سعي كل طرف لاحتواء واستقطاب اكبر عدد من الدول في مواجهته للمعسكر الأخر عبر مشاريع سياسية واقتصادية' },
                { term: 'الازمات الدولية', definition: 'هي الفترات التي تميزت فيه علاقات المعسكرين باللا استقرار والتوتر الحاد الذي لم يصل لمستوى الحرب الفعلية و من أبرزها الأزمة الكورية1953/1950 والكوبية 1962' },
                { term: 'الحرب الباردة', definition: 'هي صراع اديولوجي مذهبي حضاري و مصلحي عرفه العالم من 1945-1989ا بين المعسكر الشرقي الشيوعي الاشتراكي بقيادة السوفيات و المعسكر الغربي الليبرالي الرأسمالي بزعامة الامريكان استعملت فيه مختلف الوسائل باستثناء المواجهةالعسكرية المباشرة .' },
                { term: 'الدعاية المغرضة', definition: 'ابرز وسائل الحرب الباردة وتقوم على نشر الأفكار من أجل التأثير بوسائل الإذاعات ـ الصحف ـ ا التليفزيون ـ الإشهار' },
                { term: 'الانفراج', definition: 'هي وصف لعلاقات المعسكرين بعد تسوية أزمة كوبا الخطيرة 1962حيث تم التخلص من الشدة و الضيق اللذان وصل إليهما' },
                { term: 'التعايش السلمي', definition: 'مصطلح سياسي يقصد به إبعاد شبح الحرب الساخنة كوسيلة لتسوية الخلافات وحلها بالطرق السلمية مع القبول بازدواجية النظام الدولي في ظل التعايش و تبادل المصالح بين .1977 - 1956' },
                { term: 'مشروع مارشال', definition: 'أعلنه الوزير الأمريكي جورج مارشال في 1947 ويقضي بتقديم مساعدات مالية قدرها 13 مليار $لأوروبا من أجل إعادة اعمار دمار الحرب ع 2 لكن بشروط .' },
                { term: 'مبدأ جدانوف', definition: 'نسبة إلى السياسي السوفيتي جدانوف وهو رد على مبدا ترومان و على أساسه تم تأسيس مكتب الكومنفورم' },
                { term: 'الكومنفورم', definition: 'مكتب الإخبار الشيوعي هدفه مواجهة المشاريع الأمريكية بجمع المعلومات عنها ولذلك اعتبره الغرب مكتب للتجسس على المصالح الغربية في العالم' },
                { term: 'مشروع إيزنهاور 1957', definition: 'مشروع أمريكي برز بعد أزمة السويس يقضي بتقديم مساعدات مالية لدول الشرق الأوسط مقابل رفض الشيوعية وقبول الليبرالية .' },
                { term: 'البريستوريكا و الغلاسنوست', definition: 'كلمتين روسيتين وظفهما ميخائيل غورباتشوف لوصف سياسته الساعية إلى إدخال الشفافية و إصلاح تسير أجهزة الدولة السوفياتية و الحزب الشيوعي .' },
                { term: 'الأحادية القطبية', definition: 'نظام دولي جديد ساد العالم بعد انهيار المعسكر الشيوعي 1989 أصبحت فيه قيادة و توجيه العلاقات الدولية بيد الو م ا' },
                { term: 'الشرعية الدولية', definition: 'يقصد بها الالتزام و تنفيذ القرارات الصادرة عن الهيئات الدولية كالأمم المتحدة وأجهزتها . ما يخدم مصالح الو م أ و حلفائها .' },
                { term: 'النظام الدولي الجديد', definition: 'مفهوم برز بعد لقاء مالطا1989 و انهيار المعسكر الشيوعي يقوم على أساس توسيع مفاهيم العولمة و الليبرالية و فرض منطق الهيمنة الأمريكية على العالم .' },
                { term: 'المنظمات غير الحكومية', definition: 'هي منظمات خيرية عالمية تعرف بالمجتمع المدني موظفوها متطوعون تنشط في كافة الميادين كالبيئة . حقوق الإنسان . الإغاثة . الرعاية الصحية و الطفولة' },
                { term: 'الثورة التحريرية', definition: 'و هي فعل تحرري شامل ورد شعبي عنيف بهدف للسيادة والاستقلال من خلال العمليات العسكرية والسياسية لجيش و جبهة التحرير الوطني' },
                { term: 'النشاط المسلح', definition: 'هي مجموع العمليات العسكرية و الفدائية التي قام بها الثوار الجزائريون داخل وخارج الجزائر في الفترة الممتدة بين 1954/1962 والتي انتهت بتحقيق الاستقلال .' },
                { term: 'سياسة الإغراء', definition: 'سياسة الترغيب بواسطة المشاريع الاقتصادية و الاجتماعية التي أقرتها فرنسا في الجزائر بهدف تمزيق و السيطرة على مجتمعها و كسب عملاء .' },
                { term: 'سياسة القمع', definition: 'استعمال فرنسا لأقصى وسائل التنكيل و الإبادة و التهجير و التجهيل لإخضاع و قتل روح المقاومة في الجزائريين كما حدث في سطيف و قالمة وملعب سكيكدة و غيرها' },
                { term: 'تدويل القضية', definition: 'التعريف بالقضية الجزائرية في المحافل الدولية و الدعاية للثورة لكسب حلفاء لها' },
                { term: 'الدبلوماسية', definition: 'تلك الجهود التي بذلتها الثورة بإنشاء جهاز دبلوماسي يتحرك بين عواصم الدول و المحافل الدولية لكسب الدعم السياسي و التعاطف العالمي مع الثورة الجزائرية' },
                { term: 'مشروع جاك سوستال', definition: 'نسبة إلى صاحبه جاك سوستال الوالي العام للجزائر 1955 و قد تناول جوانب إدارية واقتصادية واجتماعية وثقافية بهدف دمج الجزائريين بفرنسا' },
                { term: 'المكاتب العربية', definition: 'جهاز إداري خاص أقامته الإدارة الفرنسية يهتم بشؤون الجزائريين ويهدف إلى ضرب الثورة' },
                { term: 'المحتشدات', definition: 'مراكز مسيجة ومغلقة و محروسة وهى إحدى الوسائل القمعية الرهيبة التي لجأت إليها فرنسا لخنق الثورة عن طريق عزل الشعب عنها وضمت قرابة 3 مليون جزائري .' },
                { term: 'مشروع قسنطينة', definition: 'هو مشروع استعماري دعائي أعلنه ديغول في 3 أكتوبر 1958 بقسنطينة و تضمن بناء 200 ألف مسكن و توزيع 250 ألف هكتار من الأراضي على الجزائريين و توظيفهم .' },
                { term: 'الجزائر جزائریة', definition: 'فكرة فرنسیة أعلن عنھا دیغول عام 1960 تنص على أن یتقلد مناصب الحكم في الجزائر من تثق فیھم الإدارة الفرنسیة أي تھميش جبھة التحریر الوطني وكل العاملین معھا .' },
                { term: 'مخطط شال وموريس', definition: ') نسبة للجنرال شال و موريس ) إجراءات عسكرية شاملة تهدف للقضاء على الثورة بتكثيف العمليات العسكرية لعزل وحدات الجيش ومنع تواصلها مع غلق الحدود تونسية والمغربية بخطين ( كهرباء حراسة ألغام ) لشل تحرك الثوار ووقف الدعم عنهم' },
                { term: 'القوة الثالثة', definition: 'طبقة برجوازية عميلة في المجتمع الجزائري دعمتها فرنسا كبديل عن الثورة و جهازها السياسي جبهة ت.و.' },
                { term: 'سلم الشجعان', definition: 'مناورة سياسية و حرب نفسية أطلقها ديغول يوم 23 – 10 - 1958 تقضي باستسلام الثوار وتسليم أسلحتهم مقابل ضمان حريتهم و سلامتهم و قد هدف الى إفراغ الثورة من محتواها وإظهارها إلى العالم على أنها ثورة جياع .' },
                { term: 'المخططات الإنمائية', definition: 'عبارة عن برامج تنموية اقتصادية و اجتماعية و ثقافية شاملة ترتكز على المنهج الاشتراكي أعدتها الجزائر المستقلة لتطوير الاقتصاد الوطني والخروج من حالة التخلف والتبعية للخارج منها المخطط الثلاثي و الرباعي ومشاريع كبرى مثل طريق الوحدة والسد الأخضر .' },
                { term: 'الثورة الزراعية', definition: 'إصلاحات جذرية للدولة الجزائرية على القطاع الزراعي سنة 1972 شعارها – الأرض لمن يخدمها – للنهوض بالقطاع وتحقيق الاكتفاء تم التراجع عنها بداية من سنة 1984' }
            ],
            geographyTerms: [
                { term: 'عالم الشمال', definition: 'الدول المتقدمة الواقعة في النصف الشمالي للأرض و يضم الدول الصناعية المكتفية و المصدرة للمواد الغذائية و المصنعة.' },
                { term: 'عالم الجنوب', definition: 'الدول المتخلفة الواقعة في النصف الجنوبي للأرض غنية بالموارد الطبيعية تعاني اللازمات السياسية و التبعية الاقتصادية' },
                { term: 'تبيض الأموال', definition: 'هي جريمة اقتصادية يتم فيها تحويل أموال غير مشروعة إلى أموال مشروعة عبر عمليات بنكيه و تجاريه' },
                { term: 'مجموعة التبادل الحر ALENA', definition: 'اتفاقية اقتصادية التبادل الحر الشمال امريكي تضم الولايات المتحدة و كندا و المكسيك' },
                { term: 'التنمية', definition: 'مجموع القرارات والإجراءات والمشاريع التي تهدف لتحقيق التطور الاقتصادي و الرفاه الاجتماعي عبر الاستغلال الأمثل للإمكانات .' },
                { term: 'رؤوس الأموال', definition: 'هي الوسائل والموارد المالية الابتدائية التي تستخدم في الإنتاج او تحسينه و هي تتوفر من تراكم فائض عمل سابق .' },
                { term: 'الاستثمار', definition: 'توظيف أموال لشراء معدات وآلات وعقارات لغرض الإنتاج و تكون مباشر بتمويلات ذاتية أو بشراكة تقوم بها الدولة.' },
                { term: 'البنك', definition: 'هو منشأة مالية تتاجر بالنقود ولها غرض رئيسي هو العمل كوسيط بين رؤوس الأموال و بين مجالات الاستثمار' },
                { term: 'البورصة', definition: 'هي سوق للتعامل مع الأوراق المالية عن طريق الاكتتاب و إصدار الأسهم و السندات' },
                { term: 'السندات', definition: 'قروض يقدمها المستثمرون إلى المؤسسات والحكومات مقابل فائدة محددة و يمكن إصدار السندات لفترات تصل إلى 30عاما' },
                { term: 'الأسهم', definition: 'ملكية في شركة ما و هي أوراق تحمل قيمة نقدية متغيرة يتم تداولها في البورصة و تحتمل ربحا او خسارة عكس السند' },
                { term: 'العملة', definition: 'هي الشكل القانوني للنقد المتداول و تشمل الأوراق و النقود المعدنية و العملة الصعبة هي العملات القابلة للتحويل إلى الدولار' },
                { term: 'العولمة', definition: 'عالمية السوق إنتاجا واستهلاكا عبر إزالة الحواجز أمام انتقال السلع و الخدمات و رؤوس الأموال و المعلومات و أنماط العيش و هي تمثل خطر و تحدي للدول المتخلفة ظهرت جليا غقب الحرب الباردة' },
                { term: 'منظمة الاوبيكOPEC', definition: 'منظمة الدول المصدرة للنفط تأسست سنة1960 بهدف حماية مصالح الأعضاء و الوقوف في وجه الكارتل العالمي و تحقيق أسعار مناسبة للمحروقات تضم: العراق،السعودية،الكويت،فنزويلا،إيران،قطر،اندونيسيا ،الإمارات العربية،الجزائر،نيجيريا،ليبيا,, مقرها فيينا' },
                { term: 'الكارتل العالمي', definition: 'اسس في 1928 من7 شركات تعرف بالشقيقات 7 (اكسن موبيل .تيكساكو .شيفرون .غولفاويل .بريتش بتروليوم . توتال )' },
                { term: 'الشركات المتعددة الجنسيات', definition: 'هي التي ملكيتها وإدارتها تخضع لسيطرة جنسيات متعددة وتمارس نشاطها في بلاد أجنبية و تملك فروعا عبر العالم و تعرف بالشركات العابرة للقارات' },
                { term: 'منظمة التجارة العالمية', definition: 'منظمة دولية تأسست سنة 1995 تعمل على تحرير التجارة العالمية قصد تسهيل تدفق السلع والخدمات و تتولى فض النزاعات التجارية بين الدول الأعضاء .' },
                { term: 'صندوق النقد الدولي', definition: 'مؤسسة مالية دولية تأسست سنة 1945 مقرها واشنطن للعمل على تسير النظام النقدي الدولي و ضمان احترام قواعده و تقديم الدعم للدول التي تواجه مشاكل مالية' },
                { term: 'البنك العالمي', definition: 'انشأ في 1946 يقدم المساعدات التقنية و القروض للدول وخاصة النامية قصد تمويل المشاريع التنموية' },
                { term: 'اقتصاد السوق', definition: 'نظام اقتصادي يقوم على قانون السوق (العرض والطلب) وعلى المبادرة الحرة والتنافس بين المؤسسات و الشركات' },
                { term: 'الأسواق العالمية', definition: 'وهي مناطق التبادل التجاري والتي تعرف حركة كثيفة في الاستيراد والتصدير ومختلف الأنشطة التجارية' },
                { term: 'مجموعة السبعة', definition: 'تضم الدول السبع الاقتصادية الكبرى في العالم وهي فرنسا ألمانيا إيطاليا بريطانيا الولايات المتحدة كندا اليابان تعقد اجتماعاتها كل سنة لبحث قضايا اقتصادية، سياسية و أمنية' },
                { term: 'مؤشر التنمية البشرية', definition: 'مقياس تأليفي تتراوح قيمته من 0 إلى 1 لقياس درجة تقدم الدول يتألف من أمل الحياة ونسبة التمدرس ومتوسط الدخل للفردي' },
                { term: 'التكتلات الاقتصادية', definition: 'هي معاهدات اقتصادية تهدف لتوحيد السياسات الاقتصادية بين الدول او بين الشركات لتحقيق مصالحها و للسيطرة على الأسواق مثل السوق الاوروبية المشتركة' },
                { term: 'الناتج الداخلي الخام', definition: 'قيمة ما تنتجه مختلف القطاعات الاقتصادية داخل البلد الواحد خلال سنة بالعملة الصعبة .' },
                { term: 'متوسط الدخل الفردي', definition: 'وهو حاصل قسمة الناتج الداخلي الخام على عدد السكان وهو مقياس نسبي' },
                { term: 'الناتج الوطني (القومي) الخام', definition: 'جملة المداخيل و القيم المضافة التي تحققها الدولة داخليا و خارجيا بالعملة الصعبة خلال سنة واحدة' },
                { term: 'تنظيم الإقليم', definition: 'هو عبارة عن هيكلة للمظاهر الجغرافية والبشرية و الاقتصادية بوضع خطة تهدف لتوفير الاحتياجات و تأخذ بعين الاعتبار الظروف و الإمكانيات و الموارد التي يتوفر عليها الإقليم' },
                { term: 'الهيمنة والنفوذ', definition: 'هي عملية السيطرة و الاستغلال التي تمارسها الدول القوية ذات الإمكانيات الضخمة على الدول الأضعف و على المؤسسات السياسية و المالية العالمية و تعني السيطرة و الاستحواذ على الأسواق و التحكم فيها من حيث العرض والطلب والأسعار .' },
                { term: 'الاستقطاب', definition: 'عملية جذب وإغراء للإفراد و ألاستثمارات و الشركات نحو دولة أو منطقة أو مدينة ما بسب الفوائد والخدمات و الضمانات و الحماية الممنوحة .' },
                { term: 'الدورة الزراعية', definition: 'هي زراعة مجموعة محاصيل بتعاقب منظم عدة سنين طبقا لنظام معين يهدف للاحتفاظ بخصوبة التربة وحماية موادها العضوية ولتنويع الإيراد الزراعي.' },
                { term: 'النطاقات', definition: 'هو تخصيص مساحة شاسعة لإنتاج محصول واحد وهي ميزة للزراعة الأمريكية (مثل نطاق الذرة. القمح . التبغ ) وتتطلب إمكانيات طبيعية وبشرية ومادية ضخمة .' },
                { term: 'مجمع المدن – ميقالوبوليس', definition: 'يطلق على منطقة حضرية واسعة تتميز بتلاحم عمراني و تعدد المدن استخدم لاول مرة لوصف الساحل الشمالي الشرقي للو م أ' },
                { term: 'الاتحاد', definition: 'مصطلح يقصد به أعلى درجات التعاون والتنسيق والتكامل بين مجموعة دول في إقليم أو قارة واحدة في الميادين السياسية و الاقتصادية والاجتماعية' },
                { term: 'التكتل', definition: 'اتحاد مجموعة دول موثق في اتفاقية له هياكل عضوية و تنظيمية موحدة يتمتع بالشخصية القانونية و له مجال جغرافي تلغى فيه كل الحواجز الجمركية بين الأعضاء' },
                { term: 'معاهدة روما', definition: 'معاهدة موقعة في 25 مارس 1957 بروما الايطالية من قبل فرنسا .ايطاليا . ألمانيا الغربية . بلجيكا . هولندا . لوكسمبورج .' },
                { term: 'البنلوكس', definition: 'دول البنلوكس هي اتحاد اقتصادي تأسس عام 1944 بين بلجيكا ، هولندا و لوكسمبورغ .' },
                { term: 'ماستريخت', definition: 'هي الاتفاقية المؤسسة للاتحاد الأوروبي تم الاتفاق عليها في مدينة ماستريخت الهولندية في 10 ديسمبر 1991.و دخلت حيز التنفيذ في 1 نوفمبر 1993' },
                { term: 'القطب الاقتصادي', definition: 'هو مركز يمثل نقطة قوة ونشاط اقتصادي كثيف لتوفره على جميع الشروط ( قاعدة . بنية تحتية . رؤوس أموال . تكنولوجيا ) التي تمكنه من إن يساهم في تفعيل الحركية الاقتصادية و ينافس أقطاب أخرى' },
                { term: 'التنينات الأربعة', definition: 'الدول 4 التي التحقت بركب التطور الصناعي منذ 1960 ( كوريا ج –هونغ كونغ – سنغافورة – تايوان ) كنتيجة لتطبيقها النموذج الياباني ( خاصة في الصناعات الدقيقة )' },
                { term: 'النمور', definition: 'الدول حديثة التصدير وهى ( تايلاند – ماليزيا – اندونيسيا – الفلبين ) تطورت بالاستثمارات اليابانية و الصينية' },
                { term: 'الآسيان', definition: 'منظمة سياسية و اقتصادية 1967 تظم 10 دول من جنوب شرق أسيا بهدف صد الشيوعية وبعد نهاية الحرب الباردة تحولت إلى منظمة تبادل حر و تعاون على التنمية في المنطقة' },
                { term: 'الوزن الديمغرافي', definition: 'هو التعداد السكاني الكبير و الذي يعتبر عامل قوة في اقتصاد منطقة إذا أحسن الاستثمار فيه و توظيف في عملية الإنتاج والتنمية' }
            ]
        }
    };

    // Mapping for displaying sub-category names in the quiz info panel
    const subCategoryLabels = {
        coldWarEvents: 'أحداث الحرب الباردة',
        algerianRevolutionEvents: 'أحداث الثورة الجزائرية',
        palestineEvents: 'أحداث فلسطين',
        coldWarPersonalities: 'شخصيات الحرب الباردة',
        algerianRevolutionPersonalities: 'شخصيات الثورة الجزائرية',
        historyTerms: 'مصطلحات التاريخ',
        geographyTerms: 'مصطلحات الجغرافيا'
    };

    // --- Utility Functions ---
    function showSection(sectionId) {
        // Remove animation class from all sections first
        inputSection.classList.remove('animate-in');
        quizSection.classList.remove('animate-in');

        inputSection.classList.add('hidden');
        quizSection.classList.add('hidden');
        
        const targetSection = document.getElementById(sectionId);
        targetSection.classList.remove('hidden');
        
        // Add animation class to the target section
        targetSection.classList.add('animate-in');
    }

    function updateInputMessage(message, type = '') {
        inputMessage.textContent = message;
        inputMessage.className = 'message';
        if (type) inputMessage.classList.add(type);
    }

    function updateQuizFeedback(message, type = '') {
        quizFeedbackDisplay.textContent = message;
        quizFeedbackDisplay.className = 'message';
        if (type) quizFeedbackDisplay.classList.add(type);
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function normalizeText(text) {
        return text.toLowerCase().trim()
                           .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '')
                           .replace(/\s+/g, ' ');
    }

    function isCloseEnough(userAnswer, correctAnswer) {
        const normalizedUser = normalizeText(userAnswer);
        const normalizedCorrect = normalizeText(correctAnswer);

        if (normalizedUser === normalizedCorrect) {
            return true;
        }
        if (normalizedCorrect.includes(normalizedUser) && normalizedUser.length > normalizedCorrect.length * 0.5) {
             return true;
        }
        if (normalizedUser.includes(normalizedCorrect) && normalizedCorrect.length > normalizedUser.length * 0.5) {
            return true;
        }
        return false;
    }

    // --- Input Section Logic ---
    function createFlashcardEntry(container, term = '', definition = '', category) {
        const entryDiv = document.createElement('div');
        entryDiv.classList.add('flashcard-entry');
        const termPlaceholder = (category === 'events' ? 'اسم الحدث' : category === 'personalities' ? 'اسم الشخصية' : 'المصطلح');
        const definitionPlaceholder = (category === 'events' ? 'التاريخ/الوصف' : category === 'personalities' ? 'التعريف' : 'التعريف');
        entryDiv.innerHTML = `
            <input type="text" class="term-input" placeholder="${termPlaceholder}" value="${term}">
            <textarea class="definition-input" placeholder="${definitionPlaceholder}">${definition}</textarea>
            <button class="remove-entry-btn">X</button>
        `;
        container.appendChild(entryDiv);

        entryDiv.querySelector('.remove-entry-btn').addEventListener('click', () => {
            entryDiv.remove();
            checkCanStartQuizButtons();
        });

        entryDiv.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('input', checkCanStartQuizButtons);
        });

        checkCanStartQuizButtons();
    }

    function collectFlashcardsFromInputs(container) {
        const currentFlashcards = [];
        const entries = container.querySelectorAll('.flashcard-entry');
        let hasEmptyField = false;

        entries.forEach(entry => {
            const term = entry.querySelector('.term-input').value.trim();
            const definition = entry.querySelector('.definition-input').value.trim();

            if (term && definition) {
                currentFlashcards.push({ term, definition });
            } else if (term || definition) {
                hasEmptyField = true;
            }
        });
        return { data: currentFlashcards, hasEmptyField: hasEmptyField };
    }

    function checkCanStartQuizButtons() {
        startQuizButtons.forEach(button => {
            const category = button.dataset.category;
            const subCategory = button.dataset.subCategory;
            
            let dataForSubCategory = [];
            if (category === 'events') {
                dataForSubCategory = defaultData.events[subCategory] || [];
            } else if (category === 'personalities') {
                dataForSubCategory = defaultData.personalities[subCategory] || [];
            } else if (category === 'terms') {
                dataForSubCategory = defaultData.terms[subCategory] || [];
            }
            button.disabled = dataForSubCategory.length === 0;
        });

        const userEventsInput = collectFlashcardsFromInputs(eventInputsContainer).data;
        const userPersonalitiesInput = collectFlashcardsFromInputs(personalityInputsContainer).data;

        let totalDefaultEvents = 0;
        for (const key in defaultData.events) {
            totalDefaultEvents += defaultData.events[key].length;
        }
        let totalDefaultPersonalities = 0;
        for (const key in defaultData.personalities) {
            totalDefaultPersonalities += defaultData.personalities[key].length;
        }
        let totalDefaultTerms = 0;
        for (const key in defaultData.terms) {
            totalDefaultTerms += defaultData.terms[key].length;
        }

        if (userEventsInput.length === 0 && userPersonalitiesInput.length === 0 &&
            totalDefaultEvents === 0 && totalDefaultPersonalities === 0 && totalDefaultTerms === 0) {
                updateInputMessage('الرجاء إضافة بيانات كاملة في أحد الأقسام على الأقل.', 'error');
        } else {
            updateInputMessage('');
        }
    }


    // --- Quiz Section Logic ---
    function startQuiz(mainCategory, subCategory) {
        currentMainCategoryKey = mainCategory;
        currentQuizSubCategoryKey = subCategory;
        currentQuizCategoryLabel = subCategoryLabels[subCategory] || 'نوع غير معروف';

        currentQuizFlashcards = defaultData[mainCategory][subCategory] || [];
        
        if (currentQuizFlashcards.length === 0) {
            updateInputMessage(`لا توجد بيانات متاحة لـ "${currentQuizCategoryLabel}". الرجاء إضافة بيانات أو اختيار فئة أخرى.`, 'error');
            showSection('input-section');
            return;
        }

        showSection('quiz-section');
        quizScore = 0;
        currentQuizIndex = 0;
        quizFeedbackDisplay.textContent = '';
        correctAnswerDisplay.classList.add('hidden');
        nextQuestionBtn.classList.add('hidden');
        restartQuizBtn.classList.add('hidden');
        helpButton.disabled = false;

        quizCategoryDisplay.textContent = currentQuizCategoryLabel;

        quizQuestions = [];
        currentQuizFlashcards.forEach(card => {
            let termQuestionPrompt;
            let definitionQuestionPrompt;

            if (mainCategory === 'events') {
                termQuestionPrompt = 'ما هو التاريخ/الوصف؟';
                definitionQuestionPrompt = 'ما هو اسم الحدث؟';
            } else if (mainCategory === 'personalities') {
                termQuestionPrompt = 'ما هو التعريف؟';
                definitionQuestionPrompt = 'ما هو اسم الشخصية؟';
            } else if (mainCategory === 'terms') {
                termQuestionPrompt = 'ما هو تعريف المصطلح؟';
                definitionQuestionPrompt = 'ما هو المصطلح؟';
            }

            quizQuestions.push({
                type: 'termToDefinition',
                question: card.term,
                answer: card.definition,
                questionPrompt: termQuestionPrompt
            });
            quizQuestions.push({
                type: 'definitionToTerm',
                question: card.definition,
                answer: card.term,
                questionPrompt: definitionQuestionPrompt
            });
        });
        quizQuestions = shuffleArray(quizQuestions);

        totalQuestionsDisplay.textContent = quizQuestions.length;
        askQuestion();
    }

    function askQuestion() {
        if (currentQuizIndex >= quizQuestions.length) {
            endQuiz();
            return;
        }

        const currentQ = quizQuestions[currentQuizIndex];
        questionCountDisplay.textContent = currentQuizIndex + 1;
        document.querySelector('.question-type').textContent = currentQ.questionPrompt;
        quizQuestionDisplay.textContent = currentQ.question;

        quizFeedbackDisplay.textContent = '';
        quizFeedbackDisplay.classList.remove('success', 'error');
        correctAnswerDisplay.classList.add('hidden');
        nextQuestionBtn.classList.add('hidden');
        
        helpUsedThisQuestion = false;
        helpButton.disabled = false;
        generateChoices(currentQ.answer, currentQ.type);
    }

    function generateChoices(correctAnswer, questionType) {
        choiceButtonsContainer.innerHTML = '';
        currentChoices = [];

        let distractorsPool = [];
        if (questionType === 'termToDefinition') {
            distractorsPool = Object.values(defaultData[currentMainCategoryKey])
                                 .flat()
                                 .map(card => card.definition);
        } else {
            distractorsPool = Object.values(defaultData[currentMainCategoryKey])
                                 .flat()
                                 .map(card => card.term);
        }
        
        const uniqueDistractors = [...new Set(distractorsPool)];

        let options = [correctAnswer];

        while (options.length < 3) {
            const randomIndex = Math.floor(Math.random() * uniqueDistractors.length);
            const potentialDistractor = uniqueDistractors[randomIndex];

            if (!isCloseEnough(potentialDistractor, correctAnswer) && !options.some(opt => isCloseEnough(opt, potentialDistractor))) {
                options.push(potentialDistractor);
            }
        }

        options = shuffleArray(options);

        options.forEach(choiceText => {
            const button = document.createElement('button');
            button.classList.add('choice-button');
            button.textContent = choiceText;
            button.dataset.answer = choiceText;
            button.addEventListener('click', () => handleChoiceClick(button, choiceText, correctAnswer));
            choiceButtonsContainer.appendChild(button);
            currentChoices.push(button);
        });
    }

    function handleChoiceClick(clickedButton, selectedAnswer, correctAnswer) {
        currentChoices.forEach(btn => btn.disabled = true);
        helpButton.disabled = true;

        const isCorrect = isCloseEnough(selectedAnswer, correctAnswer);

        if (isCorrect) {
            quizScore++;
            updateQuizFeedback('صحيح!', 'success');
            clickedButton.classList.add('correct');
        } else {
            updateQuizFeedback('غير صحيح.', 'error');
            clickedButton.classList.add('incorrect');
            correctAnswerDisplay.textContent = `الإجابة الصحيحة: "${correctAnswer}"`;
            correctAnswerDisplay.classList.remove('hidden');
            currentChoices.forEach(btn => {
                if (isCloseEnough(btn.dataset.answer, correctAnswer)) {
                    btn.classList.add('correct');
                }
            });
        }

        quizScoreDisplay.textContent = quizScore;
        nextQuestionBtn.classList.remove('hidden');
        if (currentQuizIndex < quizQuestions.length - 1) {
            nextQuestionBtn.textContent = 'السؤال التالي';
        } else {
            nextQuestionBtn.textContent = 'إنهاء الاختبار';
        }
    }

    function useHelp() {
        if (helpUsedThisQuestion || currentChoices.length <= 1) {
            helpButton.disabled = true;
            return;
        }

        helpUsedThisQuestion = true;
        helpButton.disabled = true;

        const incorrectChoices = currentChoices.filter(btn =>
            !isCloseEnough(btn.dataset.answer, quizQuestions[currentQuizIndex].answer) && !btn.classList.contains('hidden')
        );

        if (incorrectChoices.length > 1) {
            const randomIndex = Math.floor(Math.random() * incorrectChoices.length);
            incorrectChoices[randomIndex].classList.add('hidden');
        } else if (incorrectChoices.length === 1) {
            incorrectChoices[0].classList.add('hidden');
        }
    }

    function nextQuestion() {
        currentQuizIndex++;
        askQuestion();
    }

    function endQuiz() {
        updateQuizFeedback(`اكتمل الاختبار! لقد حصلت على ${quizScore} من أصل ${quizQuestions.length}.`, 'success');
        correctAnswerDisplay.classList.add('hidden');
        helpButton.classList.add('hidden');
        choiceButtonsContainer.classList.add('hidden');

        nextQuestionBtn.classList.add('hidden');

        restartQuizBtn.classList.remove('hidden');
        backToInputBtn.classList.remove('hidden');
    }

    // --- Event Listeners ---
    addEntryButtons.forEach(button => {
        button.addEventListener('click', (event) => {
            const category = event.target.dataset.category;
            let container;
            if (category === 'events') {
                container = eventInputsContainer;
            } else if (category === 'personalities') {
                container = personalityInputsContainer;
            } 
            // else if (category === 'terms') { // إذا أردت تفعيل إضافة المصطلحات يدويا
            //     container = document.getElementById('terms-inputs');
            // }
            if (container) { // تأكد من أن الحاوية موجودة قبل إضافة العنصر
                createFlashcardEntry(container, '', '', category);
            }
        });
    });

    startQuizButtons.forEach(button => {
        button.addEventListener('click', (event) => {
            const category = event.target.dataset.category;
            const subCategory = event.target.dataset.subCategory;
            startQuiz(category, subCategory);
        });
    });

    nextQuestionBtn.addEventListener('click', nextQuestion);
    restartQuizBtn.addEventListener('click', () => startQuiz(currentMainCategoryKey, currentQuizSubCategoryKey));
    backToInputBtn.addEventListener('click', () => {
        showSection('input-section');
        updateInputMessage('');
        checkCanStartQuizButtons();
        quizScoreDisplay.textContent = '0';
        questionCountDisplay.textContent = '0';
        totalQuestionsDisplay.textContent = '0';
        quizCategoryDisplay.textContent = '';
        helpButton.classList.remove('hidden');
        choiceButtonsContainer.classList.remove('hidden');
    });

    helpButton.addEventListener('click', useHelp);

    // Initial setup
    function loadDefaultFlashcardsToInputs() {
        eventInputsContainer.innerHTML = '';
        personalityInputsContainer.innerHTML = '';
        // لا نقوم بملء حقول الإدخال الافتراضية هنا لتجنب تكرار البيانات على الواجهة
        // إذا أردت عرض البيانات الافتراضية في حقول الإدخال، قم بإلغاء تعليق الأسطر التالية:
        // for (const key in defaultData.events) {
        //     defaultData.events[key].forEach(card => {
        //         createFlashcardEntry(eventInputsContainer, card.term, card.definition, 'events');
        //     });
        // }
        // for (const key in defaultData.personalities) {
        //     defaultData.personalities[key].forEach(card => {
        //         createFlashcardEntry(personalityInputsContainer, card.term, card.definition, 'personalities');
        //     });
        // }
        // إذا أردت أيضاً عرض المصطلحات في حقول إدخال خاصة بها، ستحتاج لإنشاء terms-inputs div وربطها هنا:
        // const termsInputsContainer = document.getElementById('terms-inputs');
        // if (termsInputsContainer) {
        //     for (const key in defaultData.terms) {
        //         defaultData.terms[key].forEach(card => {
        //             createFlashcardEntry(termsInputsContainer, card.term, card.definition, 'terms');
        //         });
        //     }
        // }
    }

    loadDefaultFlashcardsToInputs();
    checkCanStartQuizButtons();
    showSection('input-section');
});
